<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz das Pombagiras - Descubra Sua Protetora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --vermelho: #8B0000;
            --vermelho-escuro: #5A0000;
            --rosa: #C2185B;
            --rosa-escuro: #880E4F;
            --preto: #0A0A0A;
            --dourado: #FFD700;
            --verde-acerto: #00C853;
            --vermelho-erro: #D50000;
            --roxo: #4A148C;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--preto) 0%, var(--vermelho-escuro) 50%, var(--rosa-escuro) 100%);
            color: white;
            min-height: 100vh;
            position: relative;
            padding-bottom: 40px; /* Espa√ßo para o contador */
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* CONTADOR DE ACESSOS (discreto no canto inferior) */
        .contador-acessos {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: #FFD700;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            z-index: 1000;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .contador-acessos:hover {
            opacity: 1;
        }

        .contador-acessos i {
            margin-right: 5px;
        }

        .header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(10, 10, 10, 0.8);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 3px solid var(--dourado);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, transparent 30%, var(--rosa) 70%);
            opacity: 0.1;
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px var(--rosa);
            position: relative;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
        }

        .progress-bar {
            flex-grow: 1;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--rosa), var(--dourado));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        .quiz-container {
            background: rgba(10, 10, 10, 0.85);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--rosa);
            box-shadow: 0 10px 30px rgba(194, 24, 91, 0.3);
            position: relative;
        }

        .dificuldade {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(45deg, var(--roxo), var(--rosa));
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .pergunta {
            font-size: 1.5rem;
            margin-bottom: 30px;
            line-height: 1.4;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid var(--dourado);
        }

        .opcoes-container {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .opcao {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .opcao:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2);
        }

        .opcao.selecionada {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--dourado);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .opcao.correta {
            background: rgba(0, 200, 83, 0.3);
            border-color: var(--verde-acerto);
            animation: pulse-verde 0.5s ease;
        }

        .opcao.errada {
            background: rgba(213, 0, 0, 0.3);
            border-color: var(--vermelho-erro);
            animation: shake 0.5s ease;
        }

        @keyframes pulse-verde {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .btn-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-proximo {
            background: linear-gradient(45deg, var(--rosa), var(--vermelho));
            color: white;
            min-width: 200px;
        }

        .btn-proximo:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(194, 24, 91, 0.4);
        }

        .btn-proximo:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .resultado-container {
            text-align: center;
            padding: 40px;
            background: rgba(10, 10, 10, 0.9);
            border-radius: 20px;
            border: 3px solid var(--dourado);
            display: none;
        }

        .resultado-imagem {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--rosa);
            margin: 20px auto;
            box-shadow: 0 0 30px rgba(194, 24, 91, 0.5);
        }

        .resultado-titulo {
            font-size: 2.5rem;
            color: var(--dourado);
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .resultado-descricao {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            line-height: 1.6;
        }

        .atributos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .atributo-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--rosa);
        }

        .atributo-titulo {
            color: var(--dourado);
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .atributo-valor {
            font-size: 1.1rem;
        }

        .frase-assinatura {
            font-style: italic;
            font-size: 1.3rem;
            color: var(--dourado);
            padding: 20px;
            border-top: 2px solid var(--rosa);
            margin-top: 30px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5rem;
        }

        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--rosa);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .score-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dourado);
            text-align: center;
            margin: 20px 0;
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .error-message {
            background: rgba(213, 0, 0, 0.2);
            border: 1px solid var(--vermelho-erro);
            color: #ff9999;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .pergunta {
                font-size: 1.2rem;
            }
            
            .opcao {
                padding: 15px;
                font-size: 1rem;
            }
            
            .btn-container {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .contador-acessos {
                font-size: 0.7rem;
                padding: 3px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Contador de acessos discreto -->
    <div class="contador-acessos" id="contador-acessos">
        <i class="fas fa-eye"></i> <span id="contador-numero">0</span> acessos
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-crow"></i> Quiz das Pombagiras</h1>
            <p>Descubra qual Pombagira rege seus caminhos atrav√©s deste quiz din√¢mico. Cada resposta revela um mist√©rio!</p>
        </div>

        <div class="error-message" id="error-message"></div>

        <div class="progress-container" id="progress-container" style="display: none;">
            <span id="pergunta-atual">1</span> de <span id="total-perguntas">12</span>
            <div class="progress-bar">
                <div class="progress-fill" id="progresso"></div>
            </div>
            <div class="score-display" id="score-display">Pontua√ß√£o: 0</div>
        </div>

        <div id="quiz-area">
            <div class="quiz-container">
                <div class="dificuldade" id="dificuldade">N√≠vel 1</div>
                <div class="pergunta" id="pergunta-texto">Carregando pergunta...</div>
                <div class="opcoes-container" id="opcoes-container">
                    <!-- Op√ß√µes ser√£o inseridas aqui via JavaScript -->
                </div>
                <div class="btn-container">
                    <button class="btn btn-proximo" id="btn-proximo" onclick="proximaPergunta()" disabled>
                        <i class="fas fa-arrow-right"></i> Pr√≥xima Pergunta
                    </button>
                </div>
            </div>
        </div>

        <div class="resultado-container" id="resultado-container">
            <!-- Resultado ser√° inserido aqui via JavaScript -->
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Conectando aos mist√©rios...</p>
        </div>

        <div class="footer">
            <p>Este quiz √© uma ferramenta de autoconhecimento baseada na espiritualidade afro-brasileira</p>
            <p>¬© 2024 Quiz das Pombagiras - Todos os mist√©rios preservados</p>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO DO SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://rbygxkbewzknvjjhxdvw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJieWd4a2Jld3prbnZqamh4ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMDcxNjQsImV4cCI6MjA4MTU4MzE2NH0.YrHF9HEGo6yv9MyNsPzFgBhaAB1DRh2SLU8f7L6s1nY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ============================================
        // ESTADO DO QUIZ
        // ============================================
        const estado = {
            perguntas: [],
            perguntaAtual: 0,
            score: 0,
            respostas: [],
            sessionId: null,
            pombagiras: [],
            carregando: true,
            pageViewId: null
        };

        // ============================================
        // FUN√á√ïES PRINCIPAIS
        // ============================================

        // 1. INICIALIZAR TUDO
        async function inicializarTudo() {
            console.log("Inicializando quiz e contador...");
            
            try {
                // Registrar acesso primeiro
                await registrarAcesso();
                
                // Carregar contador atual
                await carregarContador();
                
                // Inicializar quiz
                await inicializarQuiz();
                
            } catch (error) {
                console.error("Erro na inicializa√ß√£o:", error);
                mostrarErro("Alguns recursos podem n√£o estar dispon√≠veis");
                // Continuar com fallback
                await inicializarQuiz();
            }
        }

        // 2. REGISTRAR ACESSO NA TABELA page_views
        async function registrarAcesso() {
            try {
                const pageName = 'quiz-pombagiras';
                const userAgent = navigator.userAgent;
                const referrer = document.referrer || 'direct';
                
                // Registrar novo acesso
                const { data, error } = await supabase
                    .from('page_views')
                    .insert([
                        { 
                            page_name: pageName,
                            user_agent: userAgent,
                            referrer: referrer,
                            viewed_at: new Date().toISOString()
                        }
                    ])
                    .select()
                    .single();
                
                if (error) throw error;
                
                estado.pageViewId = data.id;
                console.log("‚úÖ Acesso registrado:", data.id);
                
            } catch (error) {
                console.error("Erro ao registrar acesso:", error);
            }
        }

        // 3. CARREGAR CONTADOR DE ACESSOS
        async function carregarContador() {
            try {
                // Contar todos os acessos ao quiz
                const { count, error } = await supabase
                    .from('page_views')
                    .select('*', { count: 'exact', head: true })
                    .eq('page_name', 'quiz-pombagiras');
                
                if (error) throw error;
                
                // Atualizar contador na interface
                document.getElementById('contador-numero').textContent = count || 0;
                console.log(`üìä Total de acessos: ${count}`);
                
            } catch (error) {
                console.error("Erro ao carregar contador:", error);
                document.getElementById('contador-numero').textContent = '?';
            }
        }

        // 4. INICIALIZAR QUIZ
        async function inicializarQuiz() {
            try {
                // Carregar pombagiras
                const { data: pombagirasData, error: pombagirasError } = await supabase
                    .from('pombagiras')
                    .select('*');
                
                if (pombagirasError) throw pombagirasError;
                estado.pombagiras = pombagirasData;
                console.log(`‚úÖ ${estado.pombagiras.length} pombagiras carregadas`);
                
                // Carregar todas as perguntas
                const { data: perguntasData, error: perguntasError } = await supabase
                    .from('perguntas')
                    .select('*');
                
                if (perguntasError) throw perguntasError;
                
                // Embaralhar e pegar 12 perguntas aleat√≥rias
                estado.perguntas = perguntasData
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 12);
                
                console.log(`‚úÖ ${estado.perguntas.length} perguntas carregadas`);
                
                // Gerar ID de sess√£o √∫nico
                estado.sessionId = 'sessao_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Mostrar quiz
                mostrarQuiz();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                mostrarErro('N√£o foi poss√≠vel carregar os dados do quiz. Usando modo de demonstra√ß√£o.');
                usarDadosFallback();
                mostrarQuiz();
            }
        }

        // 5. DADOS FALLBACK
        function usarDadosFallback() {
            console.log("Usando dados de demonstra√ß√£o...");
            
            estado.pombagiras = [
                {
                    id: 1,
                    nome: "Maria Padilha",
                    descricao: "Rainha das Encruzilhadas, senhora do comando e da sedu√ß√£o.",
                    cores: ["Vermelho", "Dourado", "Preto"],
                    dia_reverencia: "Sexta-feira",
                    imagem_url: "https://raw.githubusercontent.com/alexialuzdeferro/misterio-das-giras/refs/heads/main/maria_padilha.png",
                    frase_assinatura: "Na encruzilhada do destino, eu comando!"
                },
                {
                    id: 2,
                    nome: "Maria Mulambo",
                    descricao: "Pombagira da cura e humildade. Auxilia em processos de limpeza espiritual.",
                    cores: ["Branco", "Verde-claro", "Cinza"],
                    dia_reverencia: "Segunda-feira",
                    imagem_url: "https://raw.githubusercontent.com/alexialuzdeferro/misterio-das-giras/refs/heads/main/maria_mulambo.png",
                    frase_assinatura: "Na simplicidade encontramos a verdadeira cura!"
                },
                {
                    id: 3,
                    nome: "Rosa Caveira",
                    descricao: "Senhora da justi√ßa e transforma√ß√£o. Trabalha com ciclos de vida e morte.",
                    cores: ["Preto", "Vermelho-sangue", "Roxo"],
                    dia_reverencia: "S√°bado",
                    imagem_url: "https://raw.githubusercontent.com/alexialuzdeferro/misterio-das-giras/refs/heads/main/rosa_caveira.png",
                    frase_assinatura: "Onde h√° injusti√ßa, eu planto a rosa do equil√≠brio!"
                }
            ];
            
            estado.perguntas = [
                {
                    id: 1,
                    pergunta: "Qual dia da semana √© consagrado a Maria Padilha?",
                    nivel_dificuldade: 1,
                    opcoes: ["Segunda-feira", "Quarta-feira", "Sexta-feira", "Domingo"],
                    resposta_correta: 3
                },
                {
                    id: 2,
                    pergunta: "Maria Mulambo √© conhecida principalmente por trabalhar com:",
                    nivel_dificuldade: 1,
                    opcoes: ["Guerra", "Cura", "Amor", "Dinheiro"],
                    resposta_correta: 2
                },
                {
                    id: 3,
                    pergunta: "Qual Pombagira √© conhecida como 'Rainha das Encruzilhadas'?",
                    nivel_dificuldade: 1,
                    opcoes: ["Maria Mulambo", "Rosa Caveira", "Maria Padilha", "Sete Saias"],
                    resposta_correta: 3
                }
            ];
            
            // Duplicar para ter 12 perguntas
            while (estado.perguntas.length < 12) {
                estado.perguntas = estado.perguntas.concat(estado.perguntas);
            }
            estado.perguntas = estado.perguntas.slice(0, 12);
        }

        // 6. MOSTRAR QUIZ
        function mostrarQuiz() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('quiz-area').style.display = 'block';
            document.getElementById('progress-container').style.display = 'flex';
            
            document.getElementById('total-perguntas').textContent = estado.perguntas.length;
            
            estado.carregando = false;
            mostrarPerguntaAtual();
        }

        // 7. MOSTRAR PERGUNTA ATUAL
        function mostrarPerguntaAtual() {
            if (estado.perguntaAtual >= estado.perguntas.length) {
                finalizarQuiz();
                return;
            }
            
            const pergunta = estado.perguntas[estado.perguntaAtual];
            
            // Atualizar interface
            document.getElementById('pergunta-atual').textContent = estado.perguntaAtual + 1;
            document.getElementById('pergunta-texto').textContent = pergunta.pergunta;
            document.getElementById('dificuldade').textContent = `N√≠vel ${pergunta.nivel_dificuldade}`;
            document.getElementById('btn-proximo').disabled = true;
            
            // Progresso
            const progresso = ((estado.perguntaAtual + 1) / estado.perguntas.length) * 100;
            document.getElementById('progresso').style.width = `${progresso}%`;
            
            // Score
            document.getElementById('score-display').textContent = `Pontua√ß√£o: ${estado.score}`;
            
            // Criar op√ß√µes
            const opcoesContainer = document.getElementById('opcoes-container');
            opcoesContainer.innerHTML = '';
            
            // Usar opcoes como array (formato correto do Supabase)
            const opcoesArray = pergunta.opcoes || [];
            
            opcoesArray.forEach((opcao, index) => {
                const div = document.createElement('div');
                div.className = 'opcao';
                div.innerHTML = `
                    <i class="fas fa-circle" style="font-size: 0.8em;"></i>
                    <span>${opcao}</span>
                `;
                div.onclick = () => selecionarOpcao(index);
                opcoesContainer.appendChild(div);
            });
        }

        // 8. SELECIONAR OP√á√ÉO
        function selecionarOpcao(indice) {
            const opcoes = document.querySelectorAll('.opcao');
            opcoes.forEach(op => op.classList.remove('selecionada'));
            opcoes[indice].classList.add('selecionada');
            document.getElementById('btn-proximo').disabled = false;
        }

        // 9. PR√ìXIMA PERGUNTA
        async function proximaPergunta() {
            const pergunta = estado.perguntas[estado.perguntaAtual];
            const opcaoSelecionada = document.querySelector('.opcao.selecionada');
            
            if (!opcaoSelecionada) return;
            
            const indiceSelecionado = Array.from(document.querySelectorAll('.opcao')).indexOf(opcaoSelecionada);
            const acertou = indiceSelecionado === (pergunta.resposta_correta - 1); // -1 porque as op√ß√µes come√ßam em 1
            
            // Animar resposta
            const opcoes = document.querySelectorAll('.opcao');
            opcoes.forEach((op, index) => {
                if (index === (pergunta.resposta_correta - 1)) {
                    op.classList.add('correta');
                } else if (index === indiceSelecionado && !acertou) {
                    op.classList.add('errada');
                }
            });
            
            // Atualizar score
            if (acertou) {
                estado.score += pergunta.nivel_dificuldade * 10;
            }
            
            // Registrar resposta
            estado.respostas.push({
                pergunta_id: pergunta.id,
                resposta: indiceSelecionado,
                acertou: acertou
            });
            
            // Aguardar 1.5 segundos
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            estado.perguntaAtual++;
            
            if (estado.perguntaAtual < estado.perguntas.length) {
                mostrarPerguntaAtual();
            } else {
                finalizarQuiz();
            }
        }

        // 10. FINALIZAR QUIZ
        async function finalizarQuiz() {
            // Calcular qual pombagira combina mais
            const resultado = calcularResultado();
            
            // Salvar resultado no Supabase
            await salvarResultado(resultado);
            
            // Mostrar resultado
            mostrarResultado(resultado);
        }

        // 11. CALCULAR RESULTADO
        function calcularResultado() {
            // L√≥gica aprimorada: baseado no score e tipo de respostas
            const porcentagemAcerto = (estado.score / (estado.perguntas.length * 50)) * 100;
            
            console.log(`Score: ${estado.score}, Porcentagem: ${porcentagemAcerto.toFixed(1)}%`);
            
            // Determinar categoria baseada no desempenho
            let categoria;
            if (porcentagemAcerto >= 80) {
                categoria = 'lideranca'; // Alta pontua√ß√£o = pombagiras de comando
            } else if (porcentagemAcerto >= 60) {
                categoria = 'equilibrio'; // M√©dia pontua√ß√£o = pombagiras equilibradas
            } else if (porcentagemAcerto >= 40) {
                categoria = 'cura'; // Baixa pontua√ß√£o = pombagiras de apoio
            } else {
                categoria = 'renovacao'; // Muito baixa = pombagiras de novo in√≠cio
            }
            
            // Mapear categorias para pombagiras
            const mapeamento = {
                'lideranca': [1, 3, 6],      // Maria Padilha, Maria Quit√©ria, Sete Saias
                'equilibrio': [4, 5, 7],      // Rosa Caveira, Dama da Noite, Cigana
                'cura': [2, 9, 10],           // Maria Mulambo, Pombagira da Praia, Maria Farrapo
                'renovacao': [8, 11, 12]      // Maria Navalha, Pombagira Menina, Pombagira da Figueira
            };
            
            const pombagirasCandidatas = mapeamento[categoria] || [1, 2, 3];
            const randomIndex = Math.floor(Math.random() * pombagirasCandidatas.length);
            const pombagiraId = pombagirasCandidatas[randomIndex];
            
            return estado.pombagiras.find(p => p.id === pombagiraId) || estado.pombagiras[0];
        }

        // 12. SALVAR RESULTADO NO SUPABASE
        async function salvarResultado(pombagira) {
            try {
                const { error } = await supabase
                    .from('resultados')
                    .insert([{
                        session_id: estado.sessionId,
                        respostas: estado.respostas,
                        pombagira_resultado: pombagira.id,
                        score: estado.score,
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) {
                    console.error('Erro ao salvar resultado:', error);
                } else {
                    console.log('‚úÖ Resultado salvo no Supabase');
                }
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        // 13. MOSTRAR RESULTADO
        function mostrarResultado(pombagira) {
            document.getElementById('quiz-area').style.display = 'none';
            document.getElementById('progress-container').style.display = 'none';
            
            const resultadoContainer = document.getElementById('resultado-container');
            
            // Converter arrays para string leg√≠vel
            const formatarArray = (arr) => {
                if (!arr) return 'N√£o especificado';
                if (Array.isArray(arr)) return arr.join(', ');
                return arr;
            };
            
            resultadoContainer.innerHTML = `
                <h2 class="resultado-titulo">Sua Pombagira Protetora √©:</h2>
                <h1 class="resultado-titulo" style="color: var(--rosa);">${pombagira.nome}</h1>
                
                <img src="${pombagira.imagem_url || 'https://via.placeholder.com/300x300?text=Pombagira'}" 
                     alt="${pombagira.nome}" 
                     class="resultado-imagem"
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/300x300?text=Pombagira'">
                
                <div class="resultado-descricao">
                    <p>${pombagira.descricao || 'Descri√ß√£o n√£o dispon√≠vel.'}</p>
                    ${pombagira.comandos ? `<p><strong>Comando:</strong> ${pombagira.comandos}</p>` : ''}
                </div>
                
                <div class="atributos">
                    <div class="atributo-card">
                        <div class="atributo-titulo">Dia de Rever√™ncia</div>
                        <div class="atributo-valor">${pombagira.dia_reverencia || 'N√£o especificado'}</div>
                    </div>
                    
                    <div class="atributo-card">
                        <div class="atributo-titulo">Cores</div>
                        <div class="atributo-valor">${formatarArray(pombagira.cores)}</div>
                    </div>
                    
                    ${pombagira.fase_lua ? `
                    <div class="atributo-card">
                        <div class="atributo-titulo">Fase da Lua</div>
                        <div class="atributo-valor">${pombagira.fase_lua}</div>
                    </div>
                    ` : ''}
                    
                    ${pombagira.oferendas ? `
                    <div class="atributo-card">
                        <div class="atributo-titulo">Oferendas</div>
                        <div class="atributo-valor">${formatarArray(pombagira.oferendas)}</div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="frase-assinatura">
                    <i class="fas fa-quote-left"></i>
                    ${pombagira.frase_assinatura || 'Que os caminhos se abram para voc√™!'}
                    <i class="fas fa-quote-right"></i>
                </div>
                
                <div class="btn-container" style="margin-top: 30px;">
                    <button class="btn btn-proximo" onclick="reiniciarQuiz()">
                        <i class="fas fa-redo"></i> Fazer Quiz Novamente
                    </button>
                </div>
                
                <div class="score-display" style="margin-top: 20px;">
                    Sua pontua√ß√£o: ${estado.score} pontos
                </div>
            `;
            
            resultadoContainer.style.display = 'block';
        }

        // 14. REINICIAR QUIZ
        function reiniciarQuiz() {
            estado.perguntaAtual = 0;
            estado.score = 0;
            estado.respostas = [];
            
            document.getElementById('resultado-container').style.display = 'none';
            
            // Reembaralhar perguntas
            estado.perguntas = estado.perguntas
                .sort(() => Math.random() - 0.5)
                .slice(0, 12);
            
            // Atualizar contador (novo acesso)
            carregarContador();
            
            mostrarQuiz();
        }

        // 15. MOSTRAR ERRO
        function mostrarErro(mensagem) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${mensagem}`;
            errorDiv.style.display = 'block';
            
            // Esconder ap√≥s 10 segundos
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }

        // ============================================
        // INICIAR TUDO QUANDO A P√ÅGINA CARREGAR
        // ============================================
        document.addEventListener('DOMContentLoaded', inicializarTudo);
    </script>
</body>
</html>
